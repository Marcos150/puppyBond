@model IEnumerable<MensajeViewModel>

@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Mensajes";
}

@{
    UsuarioViewModel usuario = Context.Session.Get<UsuarioViewModel>("usuario");
}

<div class="container-fluid vh-100 d-flex flex-column">
    <!-- Main Content -->
    <div class="row flex-grow-1">
        <!-- Sidebar -->
        <div class="col-3 border-end p-3 overflow-auto">
            <!-- TODO: Mostrar nombre en lugar de correo -->
            @foreach (var item in Model.DistinctBy(msg => msg.EmailUsuarioRecibe).Where(msg => msg.EmailUsuarioRecibe != usuario.Email))
            {
                <div class="user-item d-flex align-items-center mb-3">
                    <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                    <a href="/Mensajes/Index?usuarioEmail=@item.EmailUsuarioRecibe"><span>@item.EmailUsuarioRecibe</span></a>
                </div>
            }
            <!-- Imprime usuarios que te han enviado mensajes, pero tu a ellos no -->
            @foreach (var item in Model.DistinctBy(msg => msg.EmailUsuarioEnvia).Where(msg => Model.DistinctBy(msg => msg.EmailUsuarioRecibe).Where(msg => msg.EmailUsuarioRecibe != usuario.Email).Any(msg2 =>  msg.EmailUsuarioEnvia == msg2.EmailUsuarioRecibe)))
            {
                <div class="user-item d-flex align-items-center mb-3">
                    <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                    <a href="/Mensajes/Index?usuarioEmail=@item.EmailUsuarioEnvia"><span>@item.EmailUsuarioEnvia</span></a>
                </div>
            }
        </div>

        <!-- Chat Area -->
        <div class="col-9 d-flex flex-column">
            <div class="chat-messages flex-grow-1 p-3 overflow-auto">
                @foreach (var item in Model)
                {
                    @if (usuario.Email == item.EmailUsuarioRecibe)
                    {
                        <div class="message w-50 bg-light p-2 rounded mb-2 align-self-start">@item.Contenido</div>
                    }
                    @if (usuario.Email == item.EmailUsuarioEnvia)
                    {
                        <div class="message w-75 bg-primary p-2 rounded mb-2 align-self-start">@item.Contenido</div>
                    }
                }
            </div>
            @{
                //Obtiene el correo del usuario a enviar el mensaje desde query strings
                Microsoft.Extensions.Primitives.StringValues queryVal;
                Context.Request.Query.TryGetValue("correoUsuario", out queryVal);
                string correoReceptor = queryVal.FirstOrDefault() ?? Model.DistinctBy(msg => msg.EmailUsuarioRecibe).Where(msg => msg.EmailUsuarioRecibe != usuario.Email).First().EmailUsuarioRecibe;
            }
            <form action="/Mensajes/Enviar" method="post" class="chat-input d-flex align-items-center p-2 border-top">
                <input type="hidden" name="correoReceptor" value="@correoReceptor" />
                <input type="text" class="form-control me-2" placeholder="Escribe un mensaje..." name="contenido" required />
                <button class="btn btn-primary">
                    Enviar
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Estilos opcionales -->
<style>
    a {
        color: black;
        text-decoration: none;

        &:hover {
            color: black;
        }
    }
    .user-item {
        cursor: pointer;
        transition: background-color 0.3s ease;

        &:hover {
            background-color: #f8f9fa;
        }
    }

    .chat-messages {
        background-color: #e9ecef;
        border-radius: 10px;
    }

    .message {
        word-wrap: break-word;
    }

    .chat-input input {
        border-radius: 20px;
    }
</style>